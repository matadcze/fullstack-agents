map $http_upgrade $connection_upgrade {
  default upgrade;
  ''      close;
}

upstream backend_api {
  server backend:8000;
}

upstream frontend_app {
  server frontend:3000;
}

server {
  listen 80;
  server_name _;

  client_max_body_size 25m;
  sendfile on;

  # Do not expose metrics publicly
  location = /metrics {
    return 403;
  }

  location /api/ {
    proxy_pass http://backend_api;
    include /etc/nginx/snippets/proxy-headers.conf;
    proxy_buffering off;
    proxy_read_timeout 300s;
    proxy_send_timeout 300s;
  }

  # Fallback for paths like /api without trailing slash
  location /api {
    proxy_pass http://backend_api$request_uri;
    include /etc/nginx/snippets/proxy-headers.conf;
    proxy_buffering off;
    proxy_read_timeout 300s;
    proxy_send_timeout 300s;
  }

  location / {
    proxy_pass http://frontend_app;
    include /etc/nginx/snippets/proxy-headers.conf;
    proxy_read_timeout 120s;
    proxy_send_timeout 120s;
  }
}
